<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เกมดนตรีหรรษา By ครูพี่ไม้</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <style>
      .letter-box {
          width: 50px;
          height: 50px;
          margin: 5px;
          font-size: 20px;
          display: inline-block; /* Display letters in a row */
      }

      /* Style each letter box */
      .letter {
          display: inline-block;
          width: 40px;
          height: 40px;
          margin: 5px;
          text-align: center;
          line-height: 40px;
          background-color: #FFFFFF; /* Bootstrap primary color */
          color: #000; /* Text color */
          border-radius: 5px; /* Rounded corners */
          cursor: pointer; /* Cursor on hover */
      }
    </style>
</head>
<header>
  <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
          <a class="navbar-brand" href="/">เกมดนตรีหรรษา By ครูพี่ไม้</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav">
                  <li class="nav-item">
                      <a class="nav-link" href="/hangmannote">รวมผลตัวโน๊ต</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="/hangmanchord">ทะลุทะลวงตามล่าคอร์ด</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="/viewscore">ประวัติการเล่น</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="/signout"><i class="fas fa-sign-out-alt"></i> Logout</a>
                  </li>
              </ul>
          </div>
      </div>
  </nav>
</header>
<body>

<div class="center container mt-5 rounded" style="max-width: 500px;">
  <br>
  <div id="round" style="color: #FFFFFF;">ข้อที่ <span id="round-number" style="color: #FFFFFF"></span></div>
  <div id="timer" style="color: #FFFFFF">เหลือเวลา <span id="timer-count" style="color: #FFFFFF"></span> วินาที</div>
  <canvas id="hangmanCanvas" width="200" height="200"></canvas>
  <div id="guess" style="color: #FFFFFF">จงใส่โน้ตในคอร์ด <span id="guess-chord" style="color: #FFFFFF"></span></div>
  <div id="word-container" style="color: #FFFFFF; font-size: 25px;"></div>
  <div id="letters-container" style="color:#A0A0A0"></div>
  <div id="letter-box"></div>
  <div id="message" style="color: #FFFFFF"></div>
  <br>
  <div id="score-text" style="color: #FFFFFF">รวม <span id="earn-score" style="color: #FFFFFF"></span> คะแนน</div>
  <button class="btn btn-primary" id="next-round-btn" onclick="nextRound()">ข้อต่อไป</button>
  <button class="btn btn-danger" id="try-again" onclick="restartGame()">ลองใหม่</button>
  <br></br>
  <div></div>
</div>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
  const chordList = ['C','D','E','F','G','A','B','Cm','Dm','Em','Fm','Gm','Am','Bm'];
  let chordTriads = {};
  chordTriads['C'] = 'CEG';
  chordTriads['D'] = 'DF#A';
  chordTriads['E'] = 'EG#B';
  chordTriads['F'] = 'FAC';
  chordTriads['G'] = 'GBD';
  chordTriads['A'] = 'AC#E';
  chordTriads['B'] = 'BD#F#';
  chordTriads['Cm'] = 'CD#G';
  chordTriads['Dm'] = 'DFA';
  chordTriads['Em'] = 'EGB';
  chordTriads['Fm'] = 'FG#C';
  chordTriads['Gm'] = 'GA#D';
  chordTriads['Am'] = 'ACE';
  chordTriads['Bm'] = 'BDF#';
  let selectedChord = '';
  let selectedTriads = '';
  let guessedWord = [];
  let incorrectLetters = [];
  let incorrectGuessCount = 0;
  let timer;
  let gamestart = true;
  let score = 0.0;
  let roundScore = 2.0;
  const round = 5;
  let currentRound = 1;
  const canvas = document.getElementById('hangmanCanvas');
  const ctx = canvas.getContext('2d');

  const lettersContainer = document.getElementById('letters-container');
  const letterBox = document.getElementById('letter-box');
  const timerCount = document.getElementById('timer-count');
  const earnScore = document.getElementById('earn-score');
  const guessChord = document.getElementById('guess-chord');
  const roundNumber = document.getElementById('round-number');
  const scoreText = document.getElementById('score-text');

  function nextRound() {
    if (currentRound < round) {
      currentRound++;
      resetGame();
      init();
    } else{
      document.getElementById('message').innerText = 'Game Over! All rounds completed.';
      document.getElementById('next-round-btn').hidden = false;
      saveScore();
    }
  }

  function resetGame() {
    scoreText.hidden = true;
    incorrectGuessCount = 0;
    guessedWord = [];
    incorrectLetters = [];
    roundScore = 2.0;
    timer = null;
    gamestart = true;
    document.getElementById('hangmanCanvas').getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
    document.getElementById('letter-box').innerHTML = '';
    document.getElementById('message').innerText = '';
    document.getElementById('word-container').innerText = '';
    document.getElementById('letters-container').innerText = '';
    document.getElementById('timer-count').textContent = '';
    document.getElementById('earn-score').textContent = '';
    if (currentRound == round){
      document.getElementById('next-round-btn').hidden = true;
    } else{
      document.getElementById('next-round-btn').hidden = false;
    }
  }

  function selectWord() {
    selectedChord = chordList[Math.floor(Math.random() * chordList.length)];
    selectedTriads = chordTriads[selectedChord];
    guessedWord = Array(selectedTriads.length).fill('_');
    guessChord.textContent = selectedChord;
    updateWordDisplay();
  }

  function updateWordDisplay() {
    document.getElementById('word-container').innerText = guessedWord.join(' ');
  }

  function updateLettersDisplay() {
    document.getElementById('letters-container').innerText = incorrectLetters.join(', ');
  }

  function drawHangman() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = "white";
    ctx.beginPath();
    ctx.moveTo(20, 180);
    ctx.lineTo(180, 180);
    ctx.stroke();

    if (incorrectGuessCount >= 1) {
      roundScore -= 0.25;
      ctx.beginPath();
      ctx.moveTo(50, 180);
      ctx.lineTo(50, 20);
      ctx.stroke();
    }

    if (incorrectGuessCount >= 2) {
      roundScore -= 0.25;
      ctx.beginPath();
      ctx.moveTo(50, 20);
      ctx.lineTo(120, 20);
      ctx.stroke();
    }

    if (incorrectGuessCount >= 3) {
      roundScore -= 0.25;
      ctx.beginPath();
      ctx.moveTo(120, 20);
      ctx.lineTo(120, 40);
      ctx.stroke();
    }

    if (incorrectGuessCount >= 4) {
      roundScore -= 0.25;
      ctx.beginPath();
      ctx.arc(120, 60, 20, 0, 2 * Math.PI);
      ctx.stroke();
    }

    if (incorrectGuessCount >= 5) {
      roundScore -= 0.25;
      ctx.beginPath();
      ctx.moveTo(120, 80);
      ctx.lineTo(120, 130);
      ctx.stroke();
    }

    if (incorrectGuessCount >= 6) {
      roundScore -= 0.25;
      ctx.beginPath();
      ctx.moveTo(120, 130);
      ctx.lineTo(100, 170);
      ctx.stroke();
    }

    if (incorrectGuessCount >= 7) {
      roundScore -= 0.25;
      ctx.beginPath();
      ctx.moveTo(120, 130);
      ctx.lineTo(140, 170);
      ctx.stroke();
    }
  }

  function createLetterButtons() {
    const note = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    for (let letter of note) {
      const letterButton = document.createElement('span');
      letterButton.classList.add('letter');
      letterButton.innerText = letter;
      letterButton.addEventListener('click', function() {
        checkLetter(letter);
      });
      letterBox.appendChild(letterButton);
    }
  }

  function checkLetter(letter) {
    if (letter.length == 1 && selectedTriads.includes(letter)) {
      let letterCheck = false;
      for (let i = 0; i < selectedTriads.length - 1; i++) {
        if (selectedTriads[i] == letter && selectedTriads[i + 1] == '#') {
          incorrectLetters.push(letter);
          updateLettersDisplay();
          incorrectGuessCount++;
          drawHangman();
          letterCheck = false;
          break;
        } else {
          letterCheck = true;
        }
      }
      if (letterCheck == true) {
        for (let i = 0; i < selectedTriads.length; i++) {
          if (selectedTriads[i] === letter) {
            guessedWord[i] = letter;
          }
        }
      }
      updateWordDisplay();
    } else if (letter.length == 2 && selectedTriads.includes(letter)) {
      for (let i = 0; i < selectedTriads.length; i++) {
        if (selectedTriads[i] == letter[0] && selectedTriads[i + 1] == letter[1]) {
          guessedWord[i] = letter[0];
          guessedWord[i + 1] = letter[1];
        }
      }
      updateWordDisplay();
    } else {
      incorrectLetters.push(letter);
      updateLettersDisplay();
      incorrectGuessCount++;
      drawHangman();
    }

    if (guessedWord.join('') === selectedTriads) {
      document.getElementById('message').innerText = 'ยินดีด้วย คุณชนะ!';
      gamestart = false;
      if (currentRound == round) {
        saveScore();
        document.getElementById('try-again').hidden = false;
      }else{
        document.getElementById('next-round-btn').hidden = false;
      }
      score += roundScore;
      scoreText.hidden = false;
      earnScore.textContent = score;
    } else if (incorrectGuessCount === 7) {
      document.getElementById('message').innerText = `เสียใจด้วย คุณแพ้ โน๊ตที่ถูกต้องคือ ${selectedTriads}`;
      score = 0;
      gamestart = false;
      scoreText.hidden = false;
      earnScore.textContent = score;
      saveScore();
      document.getElementById('next-round-btn').hidden = true;
      document.getElementById('try-again').hidden = false;
    }
  }

  function startTimer() {
    let timeRemaining = 120;
    timerCount.textContent = timeRemaining;

    timer = setInterval(function() {
      timeRemaining--;

      if (gamestart == true) {
        if (timeRemaining >= 0) {
          timerCount.textContent = timeRemaining;
        } else {
          earnScore.textContent = score;
          clearInterval(timer);
          gamestart = false;
          document.getElementById('message').innerText = 'หมดเวลา';
          document.getElementById('letter-box').remove();
          scoreText.hidden = false;
          earnScore.textContent = score;
          saveScore();
          document.getElementById('try-again').hidden = false;
        }
      }
    }, 1000);
  }

  function saveScore() {
    $.ajax({
      type: 'POST',
      url: '/api/savescore',
      contentType: 'application/json',
      data: JSON.stringify(score),
      success: function(response) {
        console.log('Success:', response);
      },
      error: function(error) {
        console.error('Error:', error);
      }
    });
  }

  function init() {
    roundNumber.textContent = currentRound;
    document.getElementById('next-round-btn').hidden = true;
    createLetterButtons();
    selectWord();
    updateWordDisplay();
  }

  function restartGame() {
    location.reload();
  }

  init();
  document.getElementById('try-again').hidden = true;
  scoreText.hidden = true;
  startTimer();

</script>

</body>
</html>
